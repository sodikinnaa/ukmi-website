name: Git Pull Only Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --- 1. Checkout Repository ---
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 2. Setup SSH Private Key (untuk login server) ---
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- 3. Test SSH Connectivity ---
      - name: Test SSH Connection
        run: |
          echo "Testing SSH to server..."
          nc -vz ${{ secrets.SERVER_IP }} 65002 || true

      # --- 4. Deploy ke server via SSH (Git Pull Only) ---
      - name: Deploy to Server (Git Pull Only)
        id: deploy_server
        run: |
          ssh -p 65002 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} 'bash -s' <<'EOF'
            set -e
            cd "${{ secrets.SERVER_PROJECT_PATH }}"

            echo 'ðŸ“¥ Pulling latest code from GitHub...'

            # Auto fix remote jika masih HTTPS
            REMOTE_URL=$(git remote get-url origin)
            if [[ $REMOTE_URL == https* ]]; then
              echo 'ðŸ”§ Fixing remote URL to SSH...'
              git remote set-url origin git@github.com:${{ github.repository }}.git
            fi

            # Pull code
            git pull origin $GITHUB_REF_NAME

            echo 'âœ… Git pull selesai!'
          EOF

      # --- 5. Send WhatsApp Notification ---
      - name: Send WhatsApp Notification via n8n Webhook
        run: |
          curl --location 'https://n8n.siapberkarir.id/webhook/2ae67db3-34ba-4782-866b-beb3429eb42f' \
          --form "status=ukmi" \
          --form "message=${{ github.event.head_commit.message }}" \
          --form "branch=${{ github.ref_name }}"