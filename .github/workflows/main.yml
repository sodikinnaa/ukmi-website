name: Git Pull Only Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # --- 1. Checkout Repository ---
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- 2. Setup SSH Private Key (untuk login server) ---
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # --- 3. Test SSH Connectivity ---
      - name: Test SSH Connection
        run: |
          echo "Testing SSH to server..."
          nc -vz ${{ secrets.SERVER_IP }} 65002 || true

      # --- 4. Deploy ke server via SSH (Git Pull Only) ---
      - name: Deploy to Server (Git Pull Only)
        id: deploy_server
        run: |
          ssh -p 65002 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} 'bash -s' <<'EOF'
            set -e
            cd "${{ secrets.SERVER_PROJECT_PATH }}"

            echo 'ðŸ“¥ Pulling latest code from GitHub...'

            # Auto fix remote jika masih HTTPS
            REMOTE_URL=$(git remote get-url origin)
            if [[ $REMOTE_URL == https* ]]; then
              echo 'ðŸ”§ Fixing remote URL to SSH...'
              git remote set-url origin git@github.com:${{ github.repository }}.git
            fi

            # Pull code
            git pull origin $GITHUB_REF_NAME

            echo 'âœ… Git pull selesai!'
          EOF

      # --- 5. Send WhatsApp Notification ---
      - name: Send WhatsApp Notification
        if: always()
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          BRANCH="${GITHUB_REF_NAME}"

          STATUS="SUCCESS"
          if [ "${{ steps.deploy_server.outcome }}" = "failure" ]; then
            STATUS="FAILED"
          fi

          # Array nama hari dan bulan dalam Bahasa Indonesia
          HARI_IND=("Minggu" "Senin" "Selasa" "Rabu" "Kamis" "Jumat" "Sabtu")
          BULAN_IND=("Januari" "Februari" "Maret" "April" "Mei" "Juni" "Juli" "Agustus" "September" "Oktober" "November" "Desember")

          # Set zona waktu WIB
          export TZ="Asia/Jakarta"

          # Ambil informasi waktu lokal Indonesia
          JAM=$(date +"%H:%M:%S")
          TANGGAL_NUM=$(date +"%d")
          BULAN_NUM=$(date +"%m")
          BULAN_STR=${BULAN_IND[$((10#$BULAN_NUM-1))]}
          TAHUN=$(date +"%Y")
          HARI_INDEX=$(date +"%w")
          HARI_STR=${HARI_IND[$HARI_INDEX]}
          TANGGAL_IND="$TANGGAL_NUM $BULAN_STR $TAHUN"

          # Format pesan commit lebih rapi (hilangkan baris kosong yang tidak perlu, hapus spasi berlebih di awal/akhir, dan hilangkan baris trailing newline)
          TRIMMED_COMMIT_MSG=$(echo "$COMMIT_MSG" | sed '/^[[:space:]]*$/d' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

          if [ "$STATUS" == "SUCCESS" ]; then
            BODY="--------------------------------------------\n"
            BODY+="ðŸš€ Hai, update terbaru aplikasi/website Anda telah *berhasil* dilakukan! \n"
            BODY+="--------------------------------------------\n\n"
            BODY+="ðŸ“ *Detail Update yang Dikirim:*\n"
            BODY+="$TRIMMED_COMMIT_MSG\n\n"
            BODY+="ðŸ”— Website yang sudah diupdate bisa diakses di:\n"
            BODY+="    https://member.beraffiliate.com/\n\n"
            BODY+="ðŸ“… Waktu update : $JAM WIB ($HARI_STR), $TANGGAL_IND\n"
            BODY+="\nSemoga update ini bermanfaat untuk kelancaran operasional Kegiatan. Jika ada pertanyaan atau kendala seputar update ini, silakan langsung hubungi kami di wa.me/6288275426716.\n"
            BODY+="\nSalam hangat, tim pengembang.\n"
            BODY+="--------------------------------------------\n"

            # List of client phone numbers (TAMBAHKAN/EDIT DAFTAR DI SINI)
            PHONES=("6288275426716")

            for PHONE in "${PHONES[@]}"; do
              curl --location "https://sistemberita.my.id/chat/send/text" \
                --header "accept: application/json" \
                --header "Content-Type: application/json" \
                --header "token: ${{ secrets.WA_TOKEN }}" \
                --data "{\"Phone\":\"$PHONE\",\"Body\":\"$BODY\"}"
            done
          else
            BODY="--------------------------------------------\n"
            BODY+="âŒ *Deploy GAGAL!*\n"
            BODY+="--------------------------------------------\n\n"
            BODY+="Terjadi error saat proses deploy di server.\n"
            BODY+="Detail Commit Update: $TRIMMED_COMMIT_MSG\n\n"
            BODY+="â° Jam: $JAM WIB ($HARI_STR), $TANGGAL_IND\n"
            BODY+="\nSilakan segera cek server Anda untuk memperbaiki error. Update otomatis diurungkan.\n"
            BODY+="\nSalam, sistem CI/CD.\n"
            BODY+="--------------------------------------------\n"

            # HANYA kirim ke nomor 6288275426716 jika GAGAL
            curl --location "https://sistemberita.my.id/chat/send/text" \
              --header "accept: application/json" \
              --header "Content-Type: application/json" \
              --header "token: ${{ secrets.WA_TOKEN }}" \
              --data "{\"Phone\":\"6288275426716\",\"Body\":\"$BODY\"}"
          fi
